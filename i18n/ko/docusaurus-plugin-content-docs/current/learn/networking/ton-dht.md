# TON DHT 서비스

구현:

- https://github.com/ton-blockchain/ton/tree/master/dht
- https://github.com/ton-blockchain/ton/tree/master/dht-server

## 개요

Kademlia와 유사한 분산 해시 테이블(DHT; Distributed Hash Table)은 TON 프로젝트의 네트워킹 부분에서 중요한 역할을 하며 네트워크의 다른 노드를 찾는 데 사용됩니다.

TON DHT의 키는 간단히 256비트 정수입니다. 대부분의 경우 TL-직렬화된 객체의 SHA256로 계산됩니다.

이러한 256비트 키에 할당된 값은 본질적으로 제한된 길이의 임의의 바이트 스트링입니다. 이러한 바이트 스트링의 해석은 해당 키의 원래 이미지에 의해 결정되며, 이 이미지는 일반적으로 해당 키를 조회하는 노드와 해당 키를 저장하는 노드 양쪽에서 알려져 있습니다.

가장 간단한 경우, 키는 어떤 노드의 ADNL 주소를 나타내며 값은 해당 노드의 IP 주소와 포트일 수 있습니다.

TON DHT의 키-값 매핑은 DHT 노드에서 유지됩니다.

## DHT 노드

각 DHT 노드는 256비트 DHT 주소를 가지고 있습니다. ADNL 주소와는 달리 DHT 주소는 자주 변경되지 않아야 합니다. 그렇지 않으면 다른 노드들은 찾고 있는 키를 찾을 수 없을 것입니다.

키 `K`의 값은 주로 키 `K`에 가장 가까운 노드 `S`에 저장될 것으로 예상됩니다.

Kademlia 거리 = 256비트 키 `XOR` 256비트 DHT 노드 주소 (지리적 위치와는 무관합니다).

`S`는 작은 매개변수로, 예를 들어 `S = 7`처럼 설정됩니다. 이것은 DHT의 신뢰성을 향상시키기 위해 필요합니다 (키를 하나의 노드에만 유지한다면, 해당 키의 값은 그 노드가 오프라인이 될 경우 손실될 것입니다).

## Kademlia 라우팅 테이블

DHT에 참여하는 모든 노드는 일반적으로 Kademlia 라우팅 테이블을 유지합니다.

이 테이블은 0부터 255까지 번호가 매겨진 256개의 버킷으로 구성됩니다. `i`번 버킷에는 노드 주소 `a`에서 `2^i`에서 `2^(i+1) - 1`까지의 Kademlia 거리에 있는 몇 가지 알려진 노드 (일정 수의 "최상의" 노드 및 추가 후보 몇 명)에 대한 정보가 포함됩니다.

이 정보에는 그들의 DHT 주소, IP 주소 및 UDP 포트, 그리고 마지막 핑의 시간과 지연과 같은 가용성 정보가 포함됩니다.

Kademlia 노드가 어떤 쿼리의 결과로 다른 Kademlia 노드를 알게 되면, 먼저 후보로서 적절한 버킷에 그 노드를 배치합니다. 그런 다음 해당 버킷의 "최상의" 노드 중 일부가 실패하는 경우 (예: 핑 쿼리에 대한 응답이 오랜 시간동안 없는 경우), 일부 후보로 대체될 수 있습니다. 이렇게 하면 Kademlia 라우팅 테이블이 계속 유지됩니다.

## 키-값 쌍

TON DHT에는 키-값 쌍을 추가하고 업데이트할 수 있습니다.

"업데이트 규칙"은 다를 수 있습니다. 일부 경우에는 새로운 값으로 이전 값을 교체하는 것만 허용되며, 새로운 값이 소유자/생성자에 의해 서명되어야 합니다 (서명은 나중에 다른 노드들에 의해 이 키의 값을 얻은 후에 확인될 수 있도록 값의 일부로 유지되어야 합니다). 다른 경우에는 이전 값이 새 값에 영향을 미칩니다. 예를 들어 시퀀스 번호를 포함할 수 있으며, 새 시퀀스 번호가 더 큰 경우에만 이전 값을 덮어쓸 수 있습니다 (재생 공격을 방지하기 위해).

TON DHT는 ADNL 노드의 IP 주소를 저장하는 데만 사용되는 것이 아니라 다른 목적으로도 사용됩니다. TON 스토리지의 토렌트를 저장하는 노드의 주소 목록, 오버레이 서브네트워크에 포함된 노드의 주소 목록, TON 서비스의 ADNL 주소 또는 TON 블록체인 계정의 ADNL 주소 목록을 저장할 수 있습니다.

:::info
더 자세한 내용은 [DHT](/develop/network/dht) 문서에서 더 읽어보거나 [TON 화이트페이퍼](https://docs.ton.org/ton.pdf)의 3.2 장에서 확인할 수 있습니다.
:::
