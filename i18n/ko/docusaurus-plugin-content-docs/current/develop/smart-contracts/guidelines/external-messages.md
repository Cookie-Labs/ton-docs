# 외부 메시지

외부 메시지는 TON 블록체인에 있는 스마트 계약에게 특정 작업을 수행하도록 `외부에서 전송`되는 메시지입니다.

예를 들어, 지갑 스마트 계약은 지갑 소유자가 서명한 주문을 포함하는 외부 메시지를 받을 것으로 예상합니다(예: 지갑 스마트 계약에서 전송할 내부 메시지). 지갑 스마트 계약이 이러한 외부 메시지를 수신하면 먼저 서명을 확인하고, 메시지를 수락한 다음(텔레그래피 가상 머신(TVM) 원시 `ACCEPT`를 실행함), 필요한 작업을 수행합니다.

:::danger
모든 외부 메시지는 `replay attack에 대한 보호가 되어야` 합니다. 일반적으로 검증자는 제안된 외부 메시지 풀(네트워크로부터 수신한 외부 메시지)에서 외부 메시지를 제거합니다. 그러나 어떤 상황에서는 `다른 검증자`가 동일한 외부 메시지를 두 번 처리할 수 있습니다(따라서 동일한 외부 메시지에 대한 두 번째 트랜잭션을 생성하고 원래 작업을 중복해서 수행합니다). 더 나쁜 경우, `악의적인 사용자`가 처리 트랜잭션을 포함하는 블록에서 외부 메시지를 추출하고 나중에 다시 보낼 수 있습니다. 이로 인해 예를 들어 지갑 스마트 계약이 지불을 반복해야 할 수 있습니다.
:::

export const Highlight = ({children, color}) => (
<span
style={{
backgroundColor: color,
borderRadius: '2px',
color: '#4a080b',
padding: '0.2rem',
}}>
{children}
</span>
);

외부 메시지와 관련된 <Highlight color="#ffeced">replay attack에서 스마트 계약을 보호하는 가장 간단한 방법은</Highlight> 스마트 계약의 영속 데이터에 32비트 카운터 `cur-seqno`를 저장하고, 수신된 외부 메시지의 (서명된 부분에 있는) `req-seqno` 값을 예상하는 것입니다. 그런 다음 외부 메시지는 서명이 유효하고 `req-seqno`가 `cur-seqno`와 동일한 경우에만 수락됩니다. 성공적인 처리 후 영속 데이터의 `cur-seqno` 값은 하나 증가하므로 <Highlight color="#ffeced">동일한 외부 메시지는 다시 수락되지 않습니다</Highlight>.

그리고 외부 메시지에 `expire-at` 필드를 포함하고 현재 Unix 시간이 이 필드의 값보다 작은 경우에만 외부 메시지를 수락할 수 있도록 할 수도 있습니다. 이 접근 방식은 `seqno`와 함께 사용될 수 있으며, 수신 스마트 계약은 영속 데이터에 최근(만료되지 않은) 수락된 외부 메시지(해시) 집합을 저장하고, 새로운 외부 메시지가 저장된 메시지 중 하나의 중복인 경우에는 새로운 외부 메시지를 거부할 수 있습니다. 이 집합에서 만료된 메시지의 쓰레기 수집도 수행되어 영속 데이터의 부풀림을 방지해야 합니다.

:::note
일반적으로 외부 메시지는 필요한 경우 256비트 서명으로 시작하며, 필요한 경우 32비트 `req-seqno`, 32비트 `expire-at`, 그리고 `op`에 따라 필요한 경우 32비트 `op`와 다른 필수 매개변수를 포함합니다. 외부 메시지의 레이아웃은 내부 메시지와는 달리 서로 다른 스마트 계약 간 상호 작용에 사용되지 않기 때문에 내부 메시지와 같이 표준화될 필요가 없습니다(다른 개발자가 작성하고 다른 소유자가 관리하는 스마트 계약).
:::
